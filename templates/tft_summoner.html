<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TFT æˆ˜ç»© - {{ summoner_name }}</title>
    <link rel="icon" type="image/x-icon" href="/static/icon.ico" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/static/css/modern.css" />
    <style>
      body {
        background: #ffffff;
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }
      .container {
        max-width: 1400px;
      }

      /* Header Styling */
      .header-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .summoner-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 4px solid #fff;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      }

      /* Match Card Styling */
      .match-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 16px;
        border: none;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }
      .match-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      }

      /* Player Detail Row - Fixed Layout */
      .player-detail-row {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: none !important;
        border-radius: 12px;
        margin: 8px 0;
        padding: 16px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        transition: all 0.2s ease;
      }
      .player-detail-row:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      /* Fixed Grid Layout */
      .player-info-section {
        display: grid;
        grid-template-columns: 50px 120px 80px 100px;
        gap: 16px;
        align-items: center;
        min-height: 60px;
      }

      .player-avatar {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .player-name-section {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 120px;
      }

      .player-name {
        font-weight: 700;
        font-size: 0.95rem;
        color: #2d3748;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 120px;
      }

      .player-level {
        display: flex;
        justify-content: flex-start;
        align-items: center;
      }

      .level-badge {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(79, 172, 254, 0.3);
        border: none;
      }

      .player-stats {
        text-align: center;
      }

      .damage-value {
        font-weight: 700;
        font-size: 1.1rem;
        color: #e53e3e;
      }

      .damage-label {
        font-size: 0.75rem;
        color: #718096;
        margin-top: 2px;
      }

      /* Game Content Grid */
      .game-content-section {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        gap: 20px;
        align-items: center;
        margin-top: 12px;
      }

      /* Icons and Visual Elements */
      .summoner-mini-icon {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        transition: transform 0.2s ease;
      }
      .summoner-mini-icon:hover {
        transform: scale(1.05);
      }

      .champion-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        object-fit: cover;
        display: block;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .unit-container {
        position: relative;
        min-width: 48px;
        width: 48px;
        margin: 3px;
        text-align: center;
      }

      .units-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-start;
      }

      .unit-tier-badge {
        position: absolute;
        right: -4px;
        top: -4px;
        background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
        color: #1a202c;
        font-weight: 800;
        font-size: 11px;
        padding: 3px 6px;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
        border: 2px solid white;
      }

      .item-icon {
        width: 22px;
        height: 22px;
        border-radius: 4px;
        margin: 1px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
      }

      /* Trait Icons Enhanced */
      .trait-icon-container {
        display: inline-flex;
        align-items: center;
        margin: 4px;
        padding: 6px 12px;
        border-radius: 20px;
        background: linear-gradient(
          135deg,
          rgba(0, 0, 0, 0.8) 0%,
          rgba(0, 0, 0, 0.6) 100%
        );
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease;
      }
      .trait-icon-container:hover {
        transform: scale(1.05);
      }

      .trait-icon {
        width: 28px;
        height: 28px;
        margin-right: 8px;
        border-radius: 4px;
      }

      .augment-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        margin: 3px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        transition: transform 0.2s ease;
      }
      .augment-icon:hover {
        transform: scale(1.1);
      }

      /* Enhanced Trait Styles */
      .trait-icon-style-1 {
        background: linear-gradient(135deg, #cd7f32 0%, #a0522d 100%);
        box-shadow: 0 0 20px rgba(205, 127, 50, 0.3);
      }
      .trait-icon-style-2 {
        background: linear-gradient(135deg, #c0c0c0 0%, #a8a8a8 100%);
        box-shadow: 0 0 20px rgba(192, 192, 192, 0.3);
      }
      .trait-icon-style-3 {
        background: linear-gradient(135deg, #ffd700 0%, #ffb900 100%);
        color: #1a202c;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
      }
      .trait-icon-style-4 {
        background: linear-gradient(
          45deg,
          #ffd700 0%,
          #c0c0c0 25%,
          #cd7f32 50%,
          #ffd700 75%,
          #c0c0c0 100%
        );
        background-size: 200% 200%;
        animation: shimmer 2s ease-in-out infinite;
        box-shadow: 0 0 25px rgba(255, 215, 0, 0.5);
      }

      @keyframes shimmer {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      /* Placement Badges */
      .placement-badge {
        font-weight: 800;
        font-size: 1.1rem;
        padding: 8px 16px;
        border-radius: 25px;
        border: 2px solid white;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      }

      /* Summary Section */
      .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        border: none;
      }

      /* Collapse Animation */
      .collapse {
        overflow: hidden;
        transition: all 0.3s ease-in-out;
        max-height: 0;
      }
      .collapse.show {
        max-height: 2000px;
      }

      /* Loading States */
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .player-info-section {
          grid-template-columns: 40px 100px 70px 80px;
          gap: 12px;
        }
        .player-name {
          font-size: 0.85rem;
          max-width: 100px;
        }
        .game-content-section {
          grid-template-columns: 1fr;
          gap: 16px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <!-- Header Card -->
      <div class="header-card mb-4">
        <div class="d-flex align-items-center">
          <img
            src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/profileicon/{{ profile_icon_id }}.png"
            class="summoner-icon me-3"
            onerror="this.onerror=null;this.src='https://ddragon.leagueoflegends.com/cdn/15.21.1/img/profileicon/29.png';this.onerror=function(){this.src='https://raw.communitydragon.org/latest/plugins/rcp-be-lol-game-data/global/default/v1/profile-icons/0.jpg';}"
          />>>
          <div>
            <h2 class="mb-0">{{ summoner_name }}</h2>
            <p class="mb-0 text-muted">TFT æˆ˜ç»©æŸ¥è¯¢</p>
          </div>
          <a href="/" class="btn btn-outline-secondary ms-auto">è¿”å›é¦–é¡µ</a>
        </div>
      </div>

      <div id="summary-area" class="mb-3"></div>
      <div id="matches-container"></div>

      <div id="loading" class="text-center text-muted mt-4">
        <div class="spinner-border spinner-border-sm" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <span class="ms-2">æ­£åœ¨æŸ¥è¯¢ TFT æˆ˜ç»©...</span>
      </div>
    </div>

    <script id="server-data" type="application/json">
      {{ {'summoner_name': summoner_name, 'puuid': (puuid if puuid is defined else ''), 'champion_map': (champion_map if champion_map is defined else {}) }|tojson }}
    </script>
    <script>
      async function fetchJSON(url) {
        const r = await fetch(url);
        if (!r.ok) throw new Error("ç½‘ç»œé”™è¯¯ " + r.status);
        return r.json();
      }

      function renderSummary(games) {
        const total = games.length;
        const wins = games.filter((g) => g.win).length;
        const top4 = games.filter((g) => (g.placement || 8) <= 4).length;
        const winRate = total ? Math.round((wins / total) * 1000) / 10 : 0;
        const top4Rate = total ? Math.round((top4 / total) * 1000) / 10 : 0;

        document.getElementById("summary-area").innerHTML = `
        <div class="summary-card">
            <div class="row text-center">
                <div class="col-3">
                    <div class="h4 mb-0">${total}</div>
                    <div class="small">æ€»åœºæ¬¡</div>
                </div>
                <div class="col-3">
                    <div class="h4 mb-0">${winRate}%</div>
                    <div class="small">èƒœç‡ (${wins}èƒœ)</div>
                </div>
                <div class="col-3">
                    <div class="h4 mb-0">${top4Rate}%</div>
                    <div class="small">TOP4ç‡ (${top4}åœº)</div>
                </div>
                <div class="col-3">
                    <div class="h4 mb-0">${
                      Math.round(((total - wins - top4) / total) * 100) || 0
                    }%</div>
                    <div class="small">å«åº•ç‡</div>
                </div>
            </div>
        </div>
    `;
      }

      const summonerName = "{{ summoner_name.split('#')[0] }}";
      const matchesContainer = document.getElementById("matches-container");
      const loadingSpinner = document.getElementById("loading-spinner");
      const cdnUrl =
        "https://raw.communitydragon.org/latest/plugins/rcp-be-lol-game-data/global/default/assets/characters/";
      const itemCdnUrl =
        "https://raw.communitydragon.org/latest/plugins/rcp-be-lol-game-data/global/default/assets/items/";
      const augmentCdnUrl =
        "https://raw.communitydragon.org/latest/plugins/rcp-be-lol-game-data/global/default/assets/items/"; // Augments often use item icons

      let allGamesData = [];

      function createMatchCard(game, idx, summonerName) {
        const card = document.createElement("div");
        card.className = "card mb-3 match-card"; // Use mb-3 for spacing

        const resultIcon = game.win ? "ğŸ†" : "ğŸ”»";
        const placement = game.placement || 8;
        let placementClass = "placement-badge ";
        if (placement === 1) placementClass += "bg-warning text-dark";
        else if (placement <= 4) placementClass += "bg-success text-white";
        else placementClass += "bg-danger text-white";

        const placementText = `#${placement}`;

        // è·å–é¡¶çº§ç¾ç»Š (ä»åç«¯è¿”å›çš„ top_traits)
        const topTraitsHtml = (game.top_traits || [])
          .map((t) => {
            const displayName = (t.name || "").replace(/TFT\d+_/, "");
            const traitIconUrl = `https://blitz-cdn.blitz.gg/blitz/tft/traits/dark/trait-${displayName.toLowerCase()}.webp`;
            return `<div class="trait-icon-container trait-icon-style-${
              t.style || 0
            }" title="${displayName} (${t.num_units || 0})">
                    <img src="${traitIconUrl}" class="trait-icon" onerror="this.style.display='none'">
                    <span>${t.num_units || 0}</span>
                </div>`;
          })
          .join(" ");

        card.innerHTML = `
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-1 text-center">
                        <span class="${placementClass}">${placementText}</span>
                    </div>
                    <div class="col-3">
                        <div class="d-flex align-items-center gap-3">
                            <div>
                                <div class="fw-bold text-primary">${
                                  game.mode || game.gameMode
                                }</div>
                                <div class="small text-muted">${
                                  game.time_ago
                                }</div>
                            </div>
                            <div>
                                <div class="small text-muted">è½®æ¬¡: <span class="fw-bold">${
                                  game.last_round || 0
                                }</span></div>
                                <div class="small text-muted">ç­‰çº§: <span class="fw-bold">${
                                  game.level || 0
                                }</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex flex-wrap justify-content-start">${
                          topTraitsHtml ||
                          '<span class="text-muted small">æ— æ¿€æ´»ç¾ç»Š</span>'
                        }</div>
                    </div>
                    <div class="col-2 text-center">
                        <button class="btn btn-outline-primary btn-sm rounded-pill" data-idx="${idx}" title="æŸ¥çœ‹è¯¦ç»†é˜µå®¹">
                            <i class="bi bi-chevron-down me-1"></i>è¯¦æƒ…
                        </button>
                    </div>
                </div>
            </div>
            <div class="collapse" data-details-for="${idx}">
                <div class="card-footer border-0 bg-light p-0"></div>
            </div>
        `;
        return card;
      }

      function renderPlayerDetails(container, players) {
        const cdnUrl =
          "https://raw.communitydragon.org/latest/plugins/rcp-be-lol-game-data/global/default/assets/characters/";
        const itemCdnUrl =
          "https://raw.communitydragon.org/latest/plugins/rcp-be-lol-game-data/global/default/assets/items/";

        console.log("ğŸ¨ renderPlayerDetails æ¥æ”¶åˆ°çš„ç©å®¶æ•°æ®:", players);
        if (players.length > 0) {
          console.log("ğŸ¨ ç¬¬ä¸€ä¸ªç©å®¶çš„å®Œæ•´æ•°æ®:", players[0]);
        }

        let html = '<div class="list-group">';
        players
          .sort((a, b) => (a.placement || 8) - (b.placement || 8))
          .forEach((player, idx) => {
            // å°è¯•å¤šç§å¯èƒ½çš„å­—æ®µåï¼Œä¼˜å…ˆä½¿ç”¨å¸¦ tag çš„å®Œæ•´æ ¼å¼
            let summonerName = null;
            if (player.riotIdGameName && player.riotIdTagline) {
              summonerName = `${player.riotIdGameName}#${player.riotIdTagline}`;
            } else {
              summonerName =
                player.summonerName ||
                player.summoner_name ||
                player.riotIdGameName ||
                `ç©å®¶${idx + 1}`;
            }

            const level = player.level || 1;
            const goldLeft = player.gold_left || 0;
            const placement = player.placement || 8;
            const damage = player.total_damage_to_players || 0;

            console.log(`  ç©å®¶${idx + 1}: ${summonerName}`);
            console.log(`    åŸå§‹æ•°æ®:`, {
              summonerName: player.summonerName,
              riotIdGameName: player.riotIdGameName,
              riotIdTagline: player.riotIdTagline,
              units: player.units,
              unitsCount: (player.units || []).length,
            });

            // å¤„ç† units - å¯èƒ½åœ¨ä¸åŒå­—æ®µä¸­ã€‚æ˜¾ç¤ºå›¾æ ‡å¹¶å¸¦æ–‡æœ¬åå¤‡ï¼Œä»¥å…å›¾åƒè·¯å¾„å¤±æ•ˆå¯¼è‡´ä¸å¯è§
            let units = player.units || [];
            console.log(
              `    unitsæ•°é‡: ${units.length}, ç¬¬ä¸€ä¸ªunit:`,
              units[0]
            );

            const unitsHtml = units
              .map((unit) => {
                const rawId = unit.character_id || "";
                const cleanName = rawId.replace(/TFT\d+_/, "") || rawId;
                const setMatch = rawId.match(/^TFT(\d+)_/);
                const setNum = setMatch ? setMatch[1] : "latest";

                // Use Blitz CDN champion squares for unit portraits when available
                // e.g. https://blitz-cdn.blitz.gg/blitz/tft/champion_squares/set15/TFT15_Swain.webp
                const blitzUrl = `https://blitz-cdn.blitz.gg/blitz/tft/champion_squares/set${setNum}/${rawId}.webp`;

                // Fallback to CommunityDragon if Blitz image not available
                const cdnIcon1 = `${cdnUrl}${rawId.toLowerCase()}/${rawId.toLowerCase()}.png`;
                const cdnIcon2 = `https://raw.communitydragon.org/latest/game/assets/characters/${rawId.toLowerCase()}/hud/${rawId.toLowerCase()}.png`;

                // å¤„ç†è£…å¤‡ - å¯èƒ½æ˜¯ itemNames æˆ– items
                let items = unit.itemNames || unit.items || [];
                const itemsHtml = items
                  .map((item) => {
                    const itemIconUrl = `${itemCdnUrl}${item}.png`;
                    return `<img src="${itemIconUrl}" class="item-icon" title="${item}" onerror="this.style.display='none'">`;
                  })
                  .join("");

                // render compact unit with small tier badge and item icons beneath
                const tier = unit.tier || unit.star || unit.tier_current || 0;
                return `<div class="unit-container">
                        <div style="position:relative; width:32px; height:32px; margin:0 auto;">
                            <img src="${blitzUrl}" class="champion-icon" title="${rawId}"
                                 onerror="this.onerror=null; this.src='${
                                   cdnIcon1 || cdnIcon2
                                 }'; this.style.objectFit='contain';">
                            <span class="unit-tier-badge">${
                              tier > 0 ? tier : ""
                            }</span>
                        </div>
                        <div class="item-icons" style="margin-top:4px;">${itemsHtml}</div>
                    </div>`;
              })
              .join("");

            const traitsHtml = (player.traits || [])
              .filter((t) => t.style > 0)
              .map((trait) => {
                const displayName = (trait.name || "").replace(/TFT\d+_/, "");
                const traitIconUrl = `https://blitz-cdn.blitz.gg/blitz/tft/traits/dark/trait-${displayName.toLowerCase()}.webp`;
                return `<div class="trait-icon-container trait-icon-style-${trait.style}" title="${displayName} (${trait.num_units})">
                        <img src="${traitIconUrl}" class="trait-icon" onerror="this.style.display='none'">
                        <span>${trait.num_units}</span>
                    </div>`;
              })
              .join("");

            const augmentsHtml = (player.augments || [])
              .map((aug) => {
                const augName = aug.replace(/TFT\d+_Augment_/, "");
                const augIconUrl = `https://raw.communitydragon.org/latest/game/assets/ux/tft/augments/choiceui/${augName.toLowerCase()}.tft_set11.png`;
                return `<img src="${augIconUrl}" class="augment-icon" title="${augName}" onerror="this.style.display='none'">`;
              })
              .join("");

            // å¦‚æœæœ‰å¤´åƒ IDï¼Œæ˜¾ç¤ºå¤´åƒåœ¨å·¦ä¾§ï¼ˆä¼˜å…ˆä½¿ç”¨ Data Dragon çš„ profileiconï¼‰
            const profileIconId =
              player.profileIcon ||
              player.profileIconId ||
              player.profile_icon ||
              0;
            const profileSrc = profileIconId
              ? `https://ddragon.leagueoflegends.com/cdn/15.21.1/img/profileicon/${profileIconId}.png`
              : `https://raw.communitydragon.org/latest/plugins/rcp-be-lol-game-data/global/default/v1/profile-icons/0.jpg`;
            const profileLink = `/tft_summoner/${encodeURIComponent(
              summonerName
            )}`;
            const profileImgHtml = `<a href="${profileLink}" title="æŸ¥çœ‹ ${summonerName} çš„æˆ˜ç»©">
                                        <img src="${profileSrc}" class="summoner-mini-icon me-2" onerror="this.onerror=null; this.src='https://raw.communitydragon.org/latest/plugins/rcp-be-lol-game-data/global/default/v1/profile-icons/0.jpg'">
                                    </a>`;

            html += `
                <div class="list-group-item player-detail-row">
                    <!-- Fixed Grid Layout for Player Info -->
                    <div class="player-info-section">
                        <div class="player-avatar">
                            ${profileImgHtml}
                        </div>
                        <div class="player-name-section">
                            <div class="player-name" title="${summonerName}">
                                #${placement} ${summonerName}
                            </div>
                            <div class="small text-muted">é‡‘å¸: ${goldLeft}</div>
                        </div>
                        <div class="player-level">
                            <span class="badge level-badge">LV ${level}</span>
                        </div>
                        <div class="player-stats">
                            <div class="damage-value">${damage}</div>
                            <div class="damage-label">å¯¹è‹±é›„ä¼¤å®³</div>
                        </div>
                    </div>
                    
                    <!-- Game Content Section -->
                    <div class="game-content-section">
                        <div class="traits-section">
                            <div class="d-flex flex-wrap justify-content-start">${traitsHtml}</div>
                        </div>
                        <div class="units-section">
                            <div class="units-row">${unitsHtml}</div>
                        </div>
                        <div class="augments-section">
                            <div class="d-flex flex-wrap justify-content-start">${augmentsHtml}</div>
                        </div>
                    </div>
                </div>
            `;
          });
        html += "</div>";
        container.innerHTML = html;
      }

      async function fetchTftHistory() {
        const server = JSON.parse(
          document.getElementById("server-data").textContent || "{}"
        );
        const name = server.summoner_name;
        const puuid = server.puuid;

        console.log("ğŸ” TFT é¡µé¢åŠ è½½");
        console.log("  å¬å”¤å¸ˆå: " + name);
        console.log("  PUUID: " + puuid);

        // fetch TFT history
        try {
          const q = puuid
            ? `puuid=${encodeURIComponent(puuid)}`
            : `name=${encodeURIComponent(name)}`;
          const url = `/get_tft_history?${q}&count=50`;
          console.log("ğŸ“¡ è¯·æ±‚ URL: " + url);

          const res = await fetchJSON(url);
          console.log("ğŸ“¥ API å“åº”:", res);

          document.getElementById("loading").style.display = "none";

          if (!res.success) {
            console.error("âŒ API è¿”å›å¤±è´¥: " + (res.message || "æœªçŸ¥é”™è¯¯"));
            document.getElementById(
              "matches-container"
            ).innerHTML = `<div class="alert alert-warning">${
              res.message || "æ— æˆ˜ç»©"
            }</div>`;
            return;
          }

          const games = res.games || [];
          console.log("ğŸ® è·å–åˆ° " + games.length + " åœºæ¯”èµ›");

          if (games.length === 0) {
            console.warn("âš ï¸ æˆ˜ç»©åˆ—è¡¨ä¸ºç©º");
            document.getElementById(
              "matches-container"
            ).innerHTML = `<div class="alert alert-info">æš‚æ— æˆ˜ç»©æ•°æ®</div>`;
            return;
          }

          console.log("ç¬¬ä¸€åœºæ¯”èµ›æ•°æ®:", games[0]);

          renderSummary(games);
          const area = document.getElementById("matches-container");
          area.innerHTML = "";
          games.forEach((g, idx) => {
            console.log(
              `  æ¸²æŸ“æ¯”èµ› ${idx}: placement=${g.placement}, level=${g.level}, damage=${g.total_damage}`
            );
            const card = createMatchCard(g, idx, name);
            area.appendChild(card);

            // é™„åŠ å±•å¼€/æŠ˜å å¤„ç†
            const btn = card.querySelector("button[data-idx]");
            const collapseDiv = card.querySelector("[data-details-for]");
            const footer = collapseDiv.querySelector(".card-footer");

            btn.addEventListener("click", async () => {
              if (collapseDiv.classList.contains("show")) {
                collapseDiv.classList.remove("show");
                btn.innerHTML = '<i class="bi bi-chevron-down me-1"></i>è¯¦æƒ…';
              } else {
                try {
                  // ä» /get_match è·å–å®Œæ•´çš„å¯¹å±€æ•°æ®ï¼ˆæŒ‡å®š is_tft=trueï¼‰
                  btn.innerHTML =
                    '<i class="bi bi-hourglass-split me-1"></i>åŠ è½½ä¸­...';
                  btn.disabled = true;

                  const matchRes = await fetchJSON(
                    `/get_match?name=${encodeURIComponent(
                      name
                    )}&index=${idx}&is_tft=true`
                  );
                  if (matchRes.success && matchRes.game) {
                    renderMatchDetails(footer, matchRes.game);
                    collapseDiv.classList.add("show");
                    btn.innerHTML = '<i class="bi bi-chevron-up me-1"></i>æ”¶èµ·';
                  } else {
                    footer.innerHTML = `<div class="alert alert-danger m-3">è·å–å¯¹å±€è¯¦æƒ…å¤±è´¥</div>`;
                    collapseDiv.classList.add("show");
                    btn.innerHTML = '<i class="bi bi-chevron-up me-1"></i>æ”¶èµ·';
                  }
                } catch (err) {
                  console.error("è·å–å¯¹å±€è¯¦æƒ…å¤±è´¥:", err);
                  footer.innerHTML = `<div class="alert alert-danger m-3">è·å–å¯¹å±€è¯¦æƒ…å¤±è´¥: ${err.message}</div>`;
                  collapseDiv.classList.add("show");
                  btn.innerHTML = '<i class="bi bi-chevron-up me-1"></i>æ”¶èµ·';
                } finally {
                  btn.disabled = false;
                }
              }
            });
          });
        } catch (e) {
          console.error("âŒ è·å– TFT æˆ˜ç»©å¤±è´¥:", e);
          document.getElementById("loading").style.display = "none";
          document.getElementById(
            "matches-container"
          ).innerHTML = `<div class="alert alert-danger">è·å–æˆ˜ç»©å¤±è´¥: ${e.message}</div>`;
        }
      }

      function renderMatchDetails(container, game) {
        const gameJson = game.json || game;
        const participants = gameJson.participants || [];

        console.log("ğŸ¯ æ¸²æŸ“å¯¹å±€è¯¦æƒ…ï¼Œå‚ä¸è€…æ•°é‡:", participants.length);

        if (participants.length === 0) {
          container.innerHTML =
            '<div class="alert alert-warning">æ— å‚ä¸è€…æ•°æ®</div>';
          return;
        }

        renderPlayerDetails(container, participants);
      }

      // é¡µé¢åŠ è½½æ—¶è°ƒç”¨
      fetchTftHistory();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <body>
    <div class="dynamic-island-container">
      <div id="dynamic-island" class="dynamic-island island-status-idle">
        <div class="island-icon">
          <i class="bi bi-activity"></i>
        </div>
        <div class="island-content" id="realtime-status">ç­‰å¾…æŒ‡ä»¤...</div>
      </div>
    </div>

    <div id="notification-container"></div>
</html>
