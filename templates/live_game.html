<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>实时游戏详情 - LOLHelper</title>
    <link rel="icon" type="image/x-icon" href="/static/icon.ico" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <style>
      body {
        background-color: #f0f2f5;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }
      .player-card {
        transition: transform 0.2s ease;
        margin-bottom: 1rem;
      }
      .player-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .team-order {
        border-left: 4px solid #4a90e2;
      }
      .team-chaos {
        border-left: 4px solid #e74c3c;
      }
      .item-icon {
        width: 32px;
        height: 32px;
        border-radius: 4px;
        margin: 2px;
        border: 1px solid #ddd;
      }
      .champion-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid #fff;
      }
      .current-player {
        background: linear-gradient(135deg, #fff3cd 0%, #fff8e1 100%);
        border: 2px solid #ffc107;
      }
      .dead-player {
        opacity: 0.6;
        background-color: #f8d7da;
      }
      .game-timer {
        font-size: 2rem;
        font-weight: bold;
        color: #28a745;
      }
      .summoner-name-link {
        cursor: pointer;
        text-decoration: none;
        color: inherit;
      }
      .summoner-name-link:hover {
        text-decoration: underline;
        color: #0d6efd;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-controller me-2"></i>实时游戏详情</h2>
        <button id="refresh-btn" class="btn btn-primary">
          <i class="bi bi-arrow-clockwise me-1"></i>刷新
        </button>
      </div>

      <!-- 游戏信息 -->
      <div id="game-info" class="card mb-4">
        <div class="card-body text-center">
          <div class="row">
            <div class="col-md-4">
              <h5 class="text-muted">游戏模式</h5>
              <p id="game-mode" class="fs-5 mb-0">-</p>
            </div>
            <div class="col-md-4">
              <h5 class="text-muted">游戏时间</h5>
              <p id="game-time" class="game-timer mb-0">00:00</p>
            </div>
            <div class="col-md-4">
              <h5 class="text-muted">地图</h5>
              <p id="map-name" class="fs-5 mb-0">-</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 最近击杀事件 -->
      <div id="recent-kills" class="card mb-4" style="display: none">
        <div class="card-header bg-danger text-white">
          <i class="bi bi-lightning-fill me-2"></i>最近击杀
        </div>
        <div class="card-body">
          <div id="kills-list"></div>
        </div>
      </div>

      <!-- 队伍对比 -->
      <div class="row">
        <!-- ORDER队 -->
        <div class="col-lg-6 mb-4">
          <div class="card border-primary">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="bi bi-shield-fill me-2"></i>ORDER队
              </h5>
            </div>
            <div id="team-order" class="card-body">
              <p class="text-muted">加载中...</p>
            </div>
          </div>
        </div>

        <!-- CHAOS队 -->
        <div class="col-lg-6 mb-4">
          <div class="card border-danger">
            <div class="card-header bg-danger text-white">
              <h5 class="mb-0"><i class="bi bi-fire me-2"></i>CHAOS队</h5>
            </div>
            <div id="team-chaos" class="card-body">
              <p class="text-muted">加载中...</p>
            </div>
          </div>
        </div>
      </div>

      <div id="error-message" class="alert alert-warning d-none">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span id="error-text"></span>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let refreshInterval;

      async function loadGameData() {
        try {
          const response = await fetch("/get_live_game_data");
          const result = await response.json();

          if (result.success && result.inGame) {
            document.getElementById("error-message").classList.add("d-none");
            displayGameData(result.data);
          } else {
            showError(result.message || "未在游戏中");
            clearGameData();
          }
        } catch (error) {
          console.error("加载游戏数据失败:", error);
          showError("加载数据失败");
        }
      }

      function displayGameData(data) {
        // 显示游戏信息
        document.getElementById("game-mode").textContent = data.gameInfo.mode;
        document.getElementById("game-time").textContent = formatTime(
          data.gameInfo.time
        );
        document.getElementById("map-name").textContent =
          data.gameInfo.mapName || `地图${data.gameInfo.mapNumber}`;

        // 显示最近击杀
        if (data.recentKills && data.recentKills.length > 0) {
          const killsDiv = document.getElementById("recent-kills");
          killsDiv.style.display = "block";
          const killsList = document.getElementById("kills-list");
          killsList.innerHTML = data.recentKills
            .map((kill) => {
              const assistText =
                kill.assisters.length > 0
                  ? ` (助攻: ${kill.assisters.join(", ")})`
                  : "";
              return `<p class="mb-1"><strong>${
                kill.killer
              }</strong> 击杀了 <strong class="text-danger">${
                kill.victim
              }</strong>${assistText} - ${formatTime(kill.time)}</p>`;
            })
            .join("");
        }

        // 显示队伍
        displayTeam("team-order", data.teammates, "ORDER");
        displayTeam("team-chaos", data.enemies, "CHAOS");
      }

      function displayTeam(containerId, players, teamSide) {
        const container = document.getElementById(containerId);
        if (!players || players.length === 0) {
          container.innerHTML = '<p class="text-muted">暂无数据</p>';
          return;
        }

        container.innerHTML = players
          .map((player) => {
            const kdaRatio =
              player.deaths > 0
                ? ((player.kills + player.assists) / player.deaths).toFixed(2)
                : "Perfect";
            const currentPlayerClass = player.isCurrentPlayer
              ? "current-player"
              : "";
            const deadClass = player.isDead ? "dead-player" : "";
            const respawnText =
              player.isDead && player.respawnTimer > 0
                ? `<span class="badge bg-danger">复活: ${player.respawnTimer}s</span>`
                : "";

            // OP.GG integration removed: no external badges

            return `
                <div class="player-card card ${currentPlayerClass} ${deadClass} team-${teamSide.toLowerCase()}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-2 text-center">
                                <img src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/champion/${player.championRaw.replace(
                                  "game_character_displayname_",
                                  ""
                                )}.png" 
                                     alt="${player.champion}" 
                                     class="champion-icon"
                                     onerror="this.src='https://ddragon.leagueoflegends.com/cdn/15.21.1/img/profileicon/29.png'">
                                <div class="mt-1">
                                    <span class="badge bg-secondary">Lv.${
                                      player.level
                                    }</span>
                                    
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="mb-1">
                                                <a href="/summoner/${encodeURIComponent(
                                                  player.gameName +
                                                    "#" +
                                                    player.tagLine
                                                )}" 
                                                    class="summoner-name-link"
                                                    target="_blank" rel="noopener noreferrer">
                                        ${player.gameName}#${player.tagLine}
                                    </a>
                                    ${
                                      player.isCurrentPlayer
                                        ? '<span class="badge bg-warning text-dark ms-2">你</span>'
                                        : ""
                                    }
                                    ${respawnText}
                                </h6>
                                <p class="mb-1 small text-muted">
                                    <strong>${player.champion}</strong>
                                    ${
                                      player.position !== "NONE"
                                        ? `| ${player.position}`
                                        : ""
                                    }
                                </p>
                                <div class="mb-2">
                                    <span class="badge bg-dark">${
                                      player.kda
                                    }</span>
                                    <span class="badge ${
                                      kdaRatio >= 3
                                        ? "bg-success"
                                        : kdaRatio >= 2
                                        ? "bg-info"
                                        : "bg-warning"
                                    }">
                                        KDA: ${kdaRatio}
                                    </span>
                                    <span class="badge bg-primary">${
                                      player.cs
                                    } CS</span>
                                </div>
                                <div class="small text-muted">
                                    <div><strong>符文:</strong> ${
                                      player.keystone
                                    } (${player.primaryRune}/${
              player.secondaryRune
            })</div>
                                    <div><strong>召唤师技能:</strong> ${
                                      player.spell1
                                    } / ${player.spell2}</div>
                                    ${
                                      player.augments &&
                                      player.augments.length > 0
                                        ? `<div><strong class="text-warning">增强:</strong> ${player.augments
                                            .map(
                                              (aug) =>
                                                `<span class="badge bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">${aug.name}</span>`
                                            )
                                            .join(" ")}</div>`
                                        : ""
                                    }
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <h6 class="small text-muted mb-2">装备:</h6>
                                <div class="d-flex flex-wrap">
                                    ${player.items
                                      .map(
                                        (item) =>
                                          `<img src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/item/${item.id}.png" 
                                              alt="${item.name}" 
                                              class="item-icon" 
                                              title="${item.name}">`
                                      )
                                      .join("")}
                                    ${
                                      player.items.length === 0
                                        ? '<span class="text-muted small">暂无装备</span>'
                                        : ""
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
          })
          .join("");
      }

      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins.toString().padStart(2, "0")}:${secs
          .toString()
          .padStart(2, "0")}`;
      }

      function showError(message) {
        const errorDiv = document.getElementById("error-message");
        const errorText = document.getElementById("error-text");
        errorDiv.classList.remove("d-none");
        errorText.textContent = message;
      }

      function clearGameData() {
        document.getElementById("team-order").innerHTML =
          '<p class="text-muted">未在游戏中</p>';
        document.getElementById("team-chaos").innerHTML =
          '<p class="text-muted">未在游戏中</p>';
        document.getElementById("recent-kills").style.display = "none";
      }

      // 刷新按钮
      document
        .getElementById("refresh-btn")
        .addEventListener("click", loadGameData);

      // 自动刷新（每1秒）
      refreshInterval = setInterval(loadGameData, 1000);

      // 页面加载时首次加载
      loadGameData();

      // 页面卸载时清除定时器
      window.addEventListener("beforeunload", () => {
        if (refreshInterval) clearInterval(refreshInterval);
      });
    </script>
  </body>
</html>
