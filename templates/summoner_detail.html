<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ summoner_name }} - 详细战绩</title>
    <link rel="icon" type="image/x-icon" href="/static/icon.ico" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/static/css/custom.css" />

    <style>
      .result-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 999px;
        font-weight: 700;
        letter-spacing: 0.5px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        color: #ffffff;
      }
      .result-badge i {
        font-size: 1.1rem;
      }
      .result-badge.win {
        background: linear-gradient(135deg, #28a745 0%, #54d98c 100%);
      }
      .result-badge.loss {
        background: linear-gradient(135deg, #dc3545 0%, #ff6b81 100%);
      }

      .mode-badge {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 8px 16px;
        border-radius: 999px;
        font-weight: 600;
        letter-spacing: 0.3px;
        background: rgba(102, 126, 234, 0.12);
        color: #2d2f36;
        box-shadow: 0 10px 28px rgba(102, 126, 234, 0.18);
      }
      .mode-icon {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        color: #ffffff;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 8px 20px rgba(118, 75, 162, 0.35);
      }
      .mode-label {
        font-weight: 700;
        color: inherit;
      }

      .arena-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.85rem;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        color: #213547;
        background: rgba(255, 255, 255, 0.65);
      }
      .arena-badge.top {
        background: linear-gradient(
          135deg,
          rgba(40, 167, 69, 0.18),
          rgba(76, 201, 155, 0.35)
        );
        color: #146c43;
      }
      .arena-badge.bottom {
        background: linear-gradient(
          135deg,
          rgba(220, 53, 69, 0.18),
          rgba(255, 111, 145, 0.35)
        );
        color: #a1122a;
      }

      .header-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 2rem;
      }
      .summoner-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 4px solid #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .summoner-level-badge {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 6px 14px;
        border-radius: 18px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
        margin-top: 8px;
        margin-right: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }
      .header-info {
        flex: 1 1 auto;
        min-width: 260px;
      }
      .rank-panel-container {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-top: 16px;
      }
      .rank-card {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px 18px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        min-width: 240px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .rank-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.16);
      }
      .rank-card--unranked {
        opacity: 0.85;
      }
      .rank-crest {
        width: 72px;
        height: 72px;
        object-fit: contain;
        filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.25));
      }
      .rank-card-text {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .rank-card-queue {
        font-size: 0.85rem;
        font-weight: 600;
        color: #6c757d;
        letter-spacing: 0.4px;
      }
      .rank-card-tier {
        font-size: 1.25rem;
        font-weight: 700;
        color: #212529;
      }
      .rank-card-lp {
        font-size: 1rem;
        font-weight: 600;
        color: #0d6efd;
      }
      .rank-card-record {
        font-size: 0.85rem;
        color: #495057;
      }
      .rank-card-winrate {
        font-size: 0.8rem;
        color: #198754;
        font-weight: 600;
      }
      @media (max-width: 576px) {
        .rank-card {
          min-width: 100%;
        }
        .rank-crest {
          width: 60px;
          height: 60px;
        }
      }
      .ranked-badge.iron {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
      }
      .ranked-badge.bronze {
        background: linear-gradient(135deg, #cd7f32 0%, #8b5a2b 100%);
        color: white;
      }
      .ranked-badge.silver {
        background: linear-gradient(135deg, #c0c0c0 0%, #808080 100%);
        color: white;
      }
      .ranked-badge.gold {
        background: linear-gradient(135deg, #ffd700 0%, #daa520 100%);
        color: #1a202c;
      }
      .ranked-badge.platinum {
        background: linear-gradient(135deg, #00ced1 0%, #008b8b 100%);
        color: white;
      }
      .ranked-badge.emerald {
        background: linear-gradient(135deg, #50c878 0%, #3cb371 100%);
        color: white;
      }
      .ranked-badge.diamond {
        background: linear-gradient(135deg, #b9f2ff 0%, #6fa8dc 100%);
        color: #1a202c;
      }
      .ranked-badge.master {
        background: linear-gradient(135deg, #9b30ff 0%, #7b2cbf 100%);
        color: white;
      }
      .ranked-badge.grandmaster {
        background: linear-gradient(135deg, #ff4d4d 0%, #c41e3a 100%);
        color: white;
      }
      .ranked-badge.challenger {
        background: linear-gradient(135deg, #f4c430 0%, #ffdf00 100%);
        color: #1a202c;
        box-shadow: 0 3px 15px rgba(244, 196, 48, 0.5);
      }
      .ranked-badge.unranked {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
        opacity: 0.7;
      }
      .stats-badge:hover {
        transform: scale(1.05);
      }

      /* KDA Badge - 防止换行 */
      .kda-badge {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        padding: 10px 18px;
        border-radius: 18px;
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.12),
          rgba(118, 75, 162, 0.12)
        );
        box-shadow: 0 12px 30px rgba(118, 75, 162, 0.12);
        color: #2c3e50;
      }
      .kda-badge .kda-icon {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #ffffff;
        box-shadow: 0 8px 22px rgba(102, 126, 234, 0.32);
        transition: transform 0.3s ease;
      }
      .kda-badge .kda-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .kda-badge .kda-main {
        font-size: 1.15rem;
        font-weight: 700;
        letter-spacing: 0.4px;
      }
      .kda-badge .kda-sub {
        font-size: 0.8rem;
        color: rgba(44, 62, 80, 0.7);
        font-weight: 600;
      }
      .kda-badge.kda-perfect .kda-icon {
        background: linear-gradient(135deg, #ffd54f, #ff9800);
        box-shadow: 0 12px 26px rgba(255, 193, 7, 0.35);
      }
      .kda-badge.kda-perfect .kda-sub {
        color: rgba(255, 152, 0, 0.85);
      }
      .kda-badge.kda-excellent .kda-icon {
        background: linear-gradient(135deg, #28a745, #5bd27d);
        box-shadow: 0 12px 26px rgba(40, 167, 69, 0.3);
      }
      .kda-badge.kda-excellent .kda-sub {
        color: rgba(40, 167, 69, 0.8);
      }
      .kda-badge.kda-good .kda-icon {
        background: linear-gradient(135deg, #17a2b8, #66d1ff);
        box-shadow: 0 12px 26px rgba(23, 162, 184, 0.28);
      }
      .kda-badge.kda-good .kda-sub {
        color: rgba(23, 162, 184, 0.8);
      }
      .kda-badge.kda-bad .kda-icon {
        background: linear-gradient(135deg, #dc3545, #ff6b81);
        box-shadow: 0 12px 26px rgba(220, 53, 69, 0.28);
      }
      .kda-badge.kda-bad .kda-sub {
        color: rgba(220, 53, 69, 0.78);
      }
      .game-card:hover .kda-badge .kda-icon {
        transform: translateY(-2px) scale(1.05);
      }

      /* Specific Badge Colors */
      .badge-kda {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
      }
      .badge-ratio-high {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        color: white;
      }
      .badge-ratio-mid {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
      }
      .badge-ratio-low {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        color: white;
      }
      .badge-gold {
        background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
        color: #1a202c;
      }
      .badge-cs {
        background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        color: white;
      }

      /* Items Enhanced */
      .items-col {
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: wrap;
      }
      .item-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        border: 2px solid #ddd;
        margin: 2px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        transition: transform 0.2s ease;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        flex-shrink: 0;
      }
      .item-icon:hover {
        transform: scale(1.1);
      }

      /* 详情视图中的物品图标 - 更紧凑 */
      .match-details .item-icon {
        width: 30px;
        height: 30px;
        border-radius: 5px;
        margin: 0 1px;
        flex-shrink: 0; /* 防止压缩 */
      }

      /* Augments Enhanced */
      .augments-container {
        max-width: 500px;
        overflow: hidden;
      }
      .augment-icon {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: 2px solid #667eea;
        margin: 0 2px;
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2px;
        transition: transform 0.2s ease;
        flex-shrink: 0;
      }
      .augment-icon:hover {
        transform: scale(1.1);
      }
      .augments-row {
        display: flex;
        align-items: center;
        flex-wrap: nowrap; /* 不换行 */
        margin-top: 4px;
        gap: 2px;
        max-width: 100%;
        overflow: hidden;
        min-height: 24px; /* 固定最小高度 */
      }

      /* Layout Improvements */
      .game-card .card-body .row > div {
        display: flex;
        align-items: center;
      }
      .game-card .col-champion {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding-left: 30px !important; /* 向右移动，更靠近中间 */
      }
      .game-card .col-info {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center; /* 水平居中对齐 */
      }
      .game-card .col-info > div {
        width: 100%; /* 确保子元素占满宽度 */
        display: flex;
        justify-content: center; /* 内容居中 */
        flex-wrap: wrap;
      }
      .game-card .col-meta {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-end;
      }

      /* Summary Cards */
      .summary-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
        border: none;
        margin-bottom: 1rem;
      }

      /* Back Button */
      .back-button {
        position: fixed;
        top: 30px;
        right: 30px;
        z-index: 1000;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 25px;
        padding: 12px 20px;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
      }
      .back-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
      }

      /* Loading and Error States */
      .spinner-border {
        width: 3rem;
        height: 3rem;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .champion-icon {
          width: 60px;
          height: 60px;
        }
        .level-badge {
          width: 24px;
          height: 24px;
          font-size: 0.7rem;
        }
        .item-icon {
          width: 32px;
          height: 32px;
        }
        .augment-icon {
          width: 24px;
          height: 24px;
        }
        .stats-badge {
          font-size: 0.75rem;
          padding: 4px 8px;
        }
      }

      /* Game Detail Stats */
      .detail-stats {
        background: linear-gradient(
          135deg,
          rgba(26, 35, 126, 0.1) 0%,
          rgba(74, 20, 140, 0.1) 100%
        );
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 16px;
        margin-top: 12px;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 8px 0;
        padding: 8px 12px;
        border-radius: 8px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.05) 0%,
          rgba(255, 255, 255, 0.02) 100%
        );
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
      }

      .stat-item:hover {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0.05) 100%
        );
        transform: translateX(4px);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .stat-label {
        font-weight: 500;
        opacity: 0.9;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .stat-label i {
        font-size: 0.9em;
        opacity: 0.7;
      }

      .stat-value {
        font-weight: bold;
        color: #ffd700;
        background: linear-gradient(45deg, #ffd700 0%, #ffed4e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .gold-value {
        color: #ffd700;
        font-weight: bold;
      }

      .damage-bar {
        height: 6px;
        border-radius: 3px;
        margin-top: 3px;
        overflow: hidden;
      }

      .damage-segment {
        height: 100%;
        float: left;
      }

      .damage-physical {
        background-color: #d97728;
      }
      .damage-magic {
        background-color: #b833cc;
      }
      .damage-true {
        background-color: #969696;
      }

      .player-row:hover .damage-bar {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .bg-light-success {
        background-color: #d4edda !important;
      }
      .subteam-card {
        transition: all 0.2s ease;
      }
      .subteam-card:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      /* KIWI 模式紫色徽章 */
      .bg-purple {
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 100%
        ) !important;
        color: white !important;
      }

      /* 详细对局参与者样式 */
      .match-row {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        margin-bottom: 10px;
        background: white;
        border-radius: 8px;
        border-left: 4px solid #ddd;
        transition: all 0.2s ease;
        gap: 15px;
        width: 100%;
        min-width: 0; /* 允许flex子项收缩 */
        position: relative; /* 确保悬停效果不影响布局 */
        z-index: 1; /* 基础层级 */
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        min-height: 70px; /* 固定最小高度，确保所有卡片高度一致 */
      }
      .match-row:hover {
        background: #f8f9fa;
        transform: translateX(3px);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        z-index: 10; /* 悬停时提升层级 */
      }
      .match-row.win-row {
        border-left-color: #28a745;
        background: linear-gradient(
          90deg,
          rgba(40, 167, 69, 0.05) 0%,
          white 100%
        );
      }

      /* 参与者各列样式 */
      .col-player-info {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
        flex: 0 0 180px;
        overflow: hidden;
      }
      .col-player-info > div {
        flex: 1;
        min-width: 0;
      }
      .col-champion {
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 0;
        flex: 0 0 60px;
      }
      .col-kda {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; /* 垂直居中 */
        min-width: 0;
        flex: 0 0 90px;
      }
      .col-items-wrapper {
        display: flex;
        flex-direction: column;
        justify-content: center; /* 垂直居中 */
        gap: 6px;
        flex: 1 1 auto;
        min-width: 0;
        max-width: 100%;
        overflow: hidden;
        min-height: 46px; /* 固定最小高度，容纳装备图标 */
      }

      /* 头像和名字 */
      .profile-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid #ddd;
        flex-shrink: 0;
      }
      .profile-placeholder {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        flex-shrink: 0;
      }
      .player-name {
        font-weight: 600;
        color: #2c3e50;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 120px;
      }
      .player-link {
        text-decoration: none;
        color: inherit;
      }
      .player-link:hover {
        color: #667eea;
      }
      .small-muted {
        font-size: 11px;
        color: #6c757d;
      }

      /* KDA 样式 */
      .kda-prominent {
        font-weight: bold;
        font-size: 15px;
        color: #2c3e50; /* 默认深色，确保可读性 */
        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8); /* 添加白色阴影增强对比度 */
      }
      /* 详情视图中的KDA使用更明显的颜色 */
      .match-details .kda-good {
        color: #1e8449;
        font-weight: 900;
      }
      .match-details .kda-mid {
        color: #1f618d;
        font-weight: 900;
      }
      .match-details .kda-bad {
        color: #c0392b;
        font-weight: 900;
      }
      /* 主列表中的KDA颜色（原来的） */
      .kda-good {
        color: #27ae60;
      }
      .kda-mid {
        color: #3498db;
      }
      .kda-bad {
        color: #e74c3c;
      }

      /* 物品和统计行 */
      .items-row {
        display: flex;
        gap: 3px;
        flex-wrap: nowrap; /* 不换行，保持在一行内 */
        max-width: 100%;
        overflow: hidden; /* 超出部分隐藏 */
        align-items: center;
        min-height: 34px; /* 固定高度容纳一行物品图标 */
      }
      .stats-row {
        color: #6c757d;
        font-size: 11px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.2;
      }

      /* 英雄头像（详情中的） */
      .champion-icon {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        border: 2px solid #ddd;
      }
      .champion-wrapper {
        position: relative;
        display: inline-block;
      }
      .champion-wrapper .level-badge {
        position: absolute;
        bottom: -4px;
        right: -4px;
        background: #2c3e50;
        color: white;
        font-size: 10px;
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 10px;
        border: 2px solid white;
        min-width: 20px;
        text-align: center;
      }

      /* 详情容器宽度扩展 */
      .detail-stats {
        width: 100%;
        max-width: none !important;
      }
      .detail-stats .card {
        max-width: 100%;
      }
      .detail-stats .card-body {
        padding: 20px;
      }
      .detail-stats .row {
        margin: 0 -10px;
      }
      .detail-stats .col-md-6 {
        padding: 0 10px;
      }

      /* 下拉详情容器 - 关键修复：确保容器高度自适应 */
      .match-details {
        width: 100%;
        overflow: visible !important;
        min-height: auto;
        height: auto !important;
        margin-top: 15px;
        margin-bottom: 15px;
      }
      .match-details .card {
        width: 100%;
        overflow: visible;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .match-details .card-body {
        overflow: visible;
        padding: 25px;
        background: #f8f9fa;
      }
      .match-details .row {
        display: flex;
        flex-wrap: nowrap;
        align-items: flex-start;
        gap: 20px;
      }
      .match-details .col-md-6 {
        flex: 0 0 calc(50% - 10px);
        max-width: calc(50% - 10px);
        padding: 0;
        display: flex;
        flex-direction: column;
      }
      .match-details h6 {
        margin-bottom: 15px;
        font-weight: bold;
        padding: 10px 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      /* 分页样式 */
      .pagination-btn {
        padding: 10px 20px;
        margin: 0 5px;
        border: 2px solid #007bff;
        background: white;
        color: #007bff;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .pagination-btn:hover:not(:disabled) {
        background: #007bff;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      }
      .pagination-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .pagination-btn.active {
        background: #007bff;
        color: white;
      }
      .page-info {
        padding: 10px 20px;
        margin: 0 10px;
        font-weight: 600;
        color: #495057;
      }
    </style>
  </head>
  <body>
    {% set rank_emblem_base =
    'https://raw.communitydragon.org/latest/plugins/rcp-fe-lol-static-assets/global/default'
    %} {% set rank_emblems = { 'iron': rank_emblem_base ~ '/emblem-iron.png',
    'bronze': rank_emblem_base ~ '/emblem-bronze.png', 'silver':
    rank_emblem_base ~ '/emblem-silver.png', 'gold': rank_emblem_base ~
    '/emblem-gold.png', 'platinum': rank_emblem_base ~ '/emblem-platinum.png',
    'emerald': rank_emblem_base ~ '/emblem-emerald.png', 'diamond':
    rank_emblem_base ~ '/emblem-diamond.png', 'master': rank_emblem_base ~
    '/emblem-master.png', 'grandmaster': rank_emblem_base ~
    '/emblem-grandmaster.png', 'challenger': rank_emblem_base ~
    '/emblem-challenger.png', 'unranked': rank_emblem_base ~
    '/emblem-unranked.png' } %}
    <div class="container">
      <div class="header-card">
        <div class="d-flex align-items-center flex-wrap flex-lg-nowrap gap-4">
          <img
            src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/profileicon/{{ profile_icon_id }}.png"
            class="summoner-icon"
            onerror="this.onerror=null;this.src='https://ddragon.leagueoflegends.com/cdn/15.21.1/img/profileicon/29.png';"
            alt="召唤师头像"
          />
          <div class="header-info">
            <h1 class="display-4 fw-bold text-dark mb-2">
              {{ summoner_name }}
            </h1>
            <p class="lead text-muted mb-0">详细历史战绩分析</p>
            {% if summoner_level > 0 %}
            <span class="summoner-level-badge">等级 {{ summoner_level }}</span>
            {% endif %}
            <div id="rank-panel-container" class="rank-panel-container">
              {% set rank_cards = [ ('solo', ranked_solo_summary, '单双排
              (Solo/Duo)'), ('flex', ranked_flex_summary, '灵活排位 (Flex)') ]
              %} {% for queue_key, summary, default_label in rank_cards %} {%
              set label = summary.label if summary and summary.label else
              default_label %} {% set tier = summary.tier if summary else '' %}
              {% set division = summary.division if summary else '' %} {% set
              slug = tier|lower %} {% if slug not in rank_emblems %}{% set slug
              = 'unranked' %}{% endif %} {% set crest_url =
              rank_emblems.get(slug, rank_emblems['unranked']) %} {% set lp =
              summary.lp if summary else 0 %} {% set wins = summary.wins if
              summary is not none and summary.wins is not none else None %} {%
              set losses = summary.losses if summary is not none and
              summary.losses is not none else None %} {% set wins_val = wins if
              wins is not none else 0 %} {% set losses_val = losses if losses is
              not none else 0 %} {% set total_games = wins_val + losses_val %}
              {% if wins is not none and losses is not none and total_games > 0
              %} {% set winrate = ((wins_val * 100.0) / total_games)|round(1) %}
              {% else %} {% set winrate = None %} {% endif %} {% set
              card_classes = 'rank-card' + ('' if tier else '
              rank-card--unranked') %}
              <div class="{{ card_classes }}" data-queue="{{ queue_key }}">
                <img
                  src="{{ crest_url }}"
                  class="rank-crest"
                  alt="{{ tier if tier else '未上分' }} 徽章"
                  loading="lazy"
                />
                <div class="rank-card-text">
                  <div class="rank-card-queue">{{ label }}</div>
                  {% if tier %}
                  <div class="rank-card-tier">
                    {{ tier }}{% if division %} {{ division }}{% endif %}
                  </div>
                  <div class="rank-card-lp">{{ lp }} LP</div>
                  {% if wins is not none and losses is not none %}
                  <div class="rank-card-record">
                    {{ wins_val }} 胜 / {{ losses_val }} 败
                  </div>
                  {% if winrate is not none %}
                  <div class="rank-card-winrate">胜率 {{ winrate }}%</div>
                  {% endif %} {% endif %} {% else %}
                  <div class="rank-card-tier">未上分</div>
                  <div class="rank-card-lp text-muted">等待排位</div>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          <div class="ms-lg-auto">
            <a href="/" class="btn btn-outline-secondary">返回首页</a>
          </div>
        </div>
      </div>

      <div id="loading" class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">加载中...</span>
        </div>
        <p class="mt-3 text-muted">正在加载战绩数据...</p>
      </div>

      <div id="stats-summary" class="row mb-4" style="display: none">
        <!-- 统计摘要将由JavaScript填充 -->
      </div>

      <div id="games-container">
        <!-- 游戏列表将由JavaScript填充 -->
      </div>

      <div
        id="pagination-container"
        class="d-flex justify-content-center mt-4"
        style="display: none"
      >
        <!-- 分页控件将由JavaScript填充 -->
      </div>

      <div id="error-message" class="alert alert-danger d-none" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span id="error-text"></span>
      </div>
      <div id="external-champion-stats" class="mt-3">
        <!-- 外部英雄数据 (OP.GG 占位) 将在加载后填充 -->
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Server-provided data (JSON) to avoid embedding raw Jinja in JS code that breaks editor linting -->
    <script id="server-data" type="application/json">
      {{ {'summoner_name': summoner_name, 'puuid': (puuid if puuid is defined else ''), 'champion_map': (champion_map if champion_map is defined else {}) }|tojson }}
    </script>
    <script>
      const SERVER_DATA = JSON.parse(
        document.getElementById("server-data").textContent || "{}"
      );
      const summonerName = SERVER_DATA.summoner_name || "";
      const summonerPuuid = SERVER_DATA.puuid || "";
      const CHAMPION_MAP = SERVER_DATA.champion_map || {};
      const MODE_ICON_MAP = {
        CLASSIC: {
          icon: "bi bi-shield-shaded",
          badgeBg:
            "linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.25))",
          iconBg: "linear-gradient(135deg, #667eea, #764ba2)",
          iconColor: "#ffffff",
          textColor: "#2d2f36",
        },
        ARAM: {
          icon: "bi bi-snow",
          badgeBg:
            "linear-gradient(135deg, rgba(126, 214, 255, 0.2), rgba(74, 144, 226, 0.28))",
          iconBg: "linear-gradient(135deg, #74b9ff, #0984e3)",
          iconColor: "#ffffff",
          textColor: "#1b3b5f",
        },
        KIWI: {
          icon: "bi bi-hexagon-fill",
          badgeBg:
            "linear-gradient(135deg, rgba(52, 232, 158, 0.2), rgba(15, 185, 177, 0.28))",
          iconBg: "linear-gradient(135deg, #24c6dc, #2af598)",
          iconColor: "#ffffff",
          textColor: "#145a64",
        },
        CHERRY: {
          icon: "bi bi-gem",
          badgeBg:
            "linear-gradient(135deg, rgba(240, 147, 251, 0.25), rgba(245, 87, 108, 0.32))",
          iconBg: "linear-gradient(135deg, #f093fb, #f5576c)",
          iconColor: "#ffffff",
          textColor: "#5e2140",
        },
        URF: {
          icon: "bi bi-lightning-charge-fill",
          badgeBg:
            "linear-gradient(135deg, rgba(255, 196, 0, 0.22), rgba(255, 115, 0, 0.28))",
          iconBg: "linear-gradient(135deg, #ffb347, #ff851b)",
          iconColor: "#4f2f00",
          textColor: "#4f2f00",
        },
        ONEFORALL: {
          icon: "bi bi-people-fill",
          badgeBg:
            "linear-gradient(135deg, rgba(158, 197, 254, 0.22), rgba(123, 164, 255, 0.3))",
          iconBg: "linear-gradient(135deg, #4e54c8, #8f94fb)",
          iconColor: "#ffffff",
          textColor: "#2d2f36",
        },
        NEXUSBLITZ: {
          icon: "bi bi-fire",
          badgeBg:
            "linear-gradient(135deg, rgba(255, 153, 102, 0.25), rgba(255, 94, 98, 0.3))",
          iconBg: "linear-gradient(135deg, #ff512f, #dd2476)",
          iconColor: "#ffffff",
          textColor: "#5c1a16",
        },
        _default: {
          icon: "bi bi-controller",
          badgeBg:
            "linear-gradient(135deg, rgba(102, 126, 234, 0.12), rgba(118, 75, 162, 0.18))",
          iconBg: "linear-gradient(135deg, #667eea, #764ba2)",
          iconColor: "#ffffff",
          textColor: "#2d2f36",
        },
      };

      // Small helper for compact number formatting: 14300 -> 14.3k
      function fmt(n) {
        if (n === null || n === undefined) return "";
        if (Math.abs(n) >= 1000)
          return (n / 1000).toFixed(1).replace(/\.0$/, "") + "k";
        return "" + n;
      }

      function pad2(n) {
        return String(n).padStart(2, "0");
      }

      function getTimePeriod(hours) {
        if (hours < 5) return "凌晨";
        if (hours < 9) return "早上";
        if (hours < 11) return "上午";
        if (hours < 13) return "中午";
        if (hours < 18) return "下午";
        return "晚上";
      }

      function normalizeToDate(value) {
        if (value instanceof Date) {
          return Number.isNaN(value.getTime()) ? null : value;
        }
        if (typeof value === "string") {
          if (/^\d+$/.test(value)) {
            return normalizeToDate(Number(value));
          }
          const parsed = new Date(value);
          return Number.isNaN(parsed.getTime()) ? null : parsed;
        }
        if (typeof value === "number" && Number.isFinite(value)) {
          let ts = value;
          if (ts < 1e12) ts *= 1000;
          const date = new Date(ts);
          return Number.isNaN(date.getTime()) ? null : date;
        }
        return null;
      }

      function formatGameTime(value) {
        const date = normalizeToDate(value);
        if (!date) return "----/--/--";

        const year = date.getFullYear();
        const month = pad2(date.getMonth() + 1);
        const day = pad2(date.getDate());
        const hours24 = date.getHours();
        const minutes = pad2(date.getMinutes());
        const seconds = pad2(date.getSeconds());
        const period = getTimePeriod(hours24);
        const hours12 = hours24 % 12 === 0 ? 12 : hours24 % 12;

        const offsetMinutes = -date.getTimezoneOffset();
        const sign = offsetMinutes >= 0 ? "+" : "-";
        const offsetAbs = Math.abs(offsetMinutes);
        const offsetHours = pad2(Math.floor(offsetAbs / 60));
        const offsetRemain = pad2(offsetAbs % 60);
        const tzLabel = `GMT${sign}${offsetHours}:${offsetRemain}`;

        return `${year}/${month}/${day} ${period} ${pad2(
          hours12
        )}:${minutes}:${seconds} ${tzLabel}`;
      }

      const RANK_EMBLEM_BASE =
        "https://raw.communitydragon.org/latest/plugins/rcp-fe-lol-static-assets/global/default/images/ranked-emblems";
      const RANK_EMBLEM_MAP = {
        iron: `${RANK_EMBLEM_BASE}/emblem-iron.png`,
        bronze: `${RANK_EMBLEM_BASE}/emblem-bronze.png`,
        silver: `${RANK_EMBLEM_BASE}/emblem-silver.png`,
        gold: `${RANK_EMBLEM_BASE}/emblem-gold.png`,
        platinum: `${RANK_EMBLEM_BASE}/emblem-platinum.png`,
        emerald: `${RANK_EMBLEM_BASE}/emblem-emerald.png`,
        diamond: `${RANK_EMBLEM_BASE}/emblem-diamond.png`,
        master: `${RANK_EMBLEM_BASE}/emblem-master.png`,
        grandmaster: `${RANK_EMBLEM_BASE}/emblem-grandmaster.png`,
        challenger: `${RANK_EMBLEM_BASE}/emblem-challenger.png`,
        unranked: `${RANK_EMBLEM_BASE}/emblem-unranked.png`,
      };

      function toInt(value) {
        if (value === null || value === undefined || value === "") {
          return null;
        }
        const num = Number(value);
        if (!Number.isFinite(num)) {
          return null;
        }
        return Math.trunc(num);
      }

      function sanitizeRankToken(value) {
        if (value === null || value === undefined) return "";
        const token = value.toString().trim().toUpperCase();
        return ["", "NA", "NONE", "UNRANKED", "UNSPECIFIED", "N/A"].includes(
          token
        )
          ? ""
          : token;
      }

      function summarizeRankQueue(queue, defaultLabel) {
        const summary = {
          label: defaultLabel,
          tier: "",
          division: "",
          lp: 0,
          wins: null,
          losses: null,
          crestSlug: "unranked",
          crest: RANK_EMBLEM_MAP.unranked,
          winRate: null,
          hasRecord: false,
        };

        if (!queue || typeof queue !== "object") {
          return summary;
        }

        // Debug: log the queue object to see what fields are available
        console.log(`[Rank Debug] ${defaultLabel}:`, queue);

        const tier = sanitizeRankToken(
          queue.tier || queue.tierName || queue.tierNameShort
        );
        if (tier) {
          summary.tier = tier;
        }

        const division = sanitizeRankToken(
          queue.division || queue.divisionName || queue.rank
        );
        if (division) {
          summary.division = division;
        }

        const lpSources = [
          queue.leaguePoints,
          queue.leaguePointsEarned,
          queue.lp,
          queue.league_points,
        ];
        for (const candidate of lpSources) {
          const parsed = toInt(candidate);
          if (parsed !== null) {
            summary.lp = parsed;
            break;
          }
        }

        const wins = toInt(queue.wins);
        if (wins !== null) {
          summary.wins = wins;
        }

        // Try multiple possible field names for losses
        const lossesValue =
          queue.losses ?? queue.loss ?? queue.defeats ?? queue.lossCount;
        const losses = toInt(lossesValue);
        if (losses !== null) {
          summary.losses = losses;
        }

        const slugCandidate = summary.tier
          ? summary.tier.toLowerCase()
          : "unranked";
        const slug = RANK_EMBLEM_MAP[slugCandidate]
          ? slugCandidate
          : "unranked";
        summary.crestSlug = slug;
        summary.crest = RANK_EMBLEM_MAP[slug];

        const winsVal = summary.wins ?? 0;
        const lossesVal = summary.losses ?? 0;
        const total = winsVal + lossesVal;
        summary.hasRecord =
          summary.wins !== null && summary.losses !== null && total >= 0;
        if (summary.hasRecord && total > 0) {
          summary.winRate = ((winsVal / total) * 100).toFixed(1);
        }

        return summary;
      }

      function createRankCard(summary, queueKey) {
        const card = document.createElement("div");
        card.className =
          "rank-card" + (summary.tier ? "" : " rank-card--unranked");
        if (queueKey) {
          card.dataset.queue = queueKey;
        }

        const crest = document.createElement("img");
        crest.className = "rank-crest";
        crest.src = summary.crest;
        crest.alt = `${summary.tier || "未上分"} 徽章`;
        crest.loading = "lazy";

        // Handle CDN failure gracefully - show a placeholder instead of breaking the UI
        crest.onerror = function () {
          // Use a simple SVG placeholder or hide the image
          this.style.opacity = "0.3";
          this.style.filter = "grayscale(100%)";
          console.warn(`Failed to load rank emblem from CDN: ${this.src}`);
        };

        card.appendChild(crest);

        const text = document.createElement("div");
        text.className = "rank-card-text";

        const queueLabel = document.createElement("div");
        queueLabel.className = "rank-card-queue";
        queueLabel.textContent = summary.label;
        text.appendChild(queueLabel);

        if (summary.tier) {
          const tierLine = document.createElement("div");
          tierLine.className = "rank-card-tier";
          tierLine.textContent = summary.division
            ? `${summary.tier} ${summary.division}`
            : summary.tier;
          text.appendChild(tierLine);

          const lpLine = document.createElement("div");
          lpLine.className = "rank-card-lp";
          lpLine.textContent = `${summary.lp} LP`;
          text.appendChild(lpLine);

          if (summary.hasRecord) {
            const record = document.createElement("div");
            record.className = "rank-card-record";
            record.textContent = `${summary.wins ?? 0} 胜 / ${
              summary.losses ?? 0
            } 败`;
            text.appendChild(record);

            if (summary.winRate) {
              const rate = document.createElement("div");
              rate.className = "rank-card-winrate";
              rate.textContent = `胜率 ${summary.winRate}%`;
              text.appendChild(rate);
            }
          }
        } else {
          const tierLine = document.createElement("div");
          tierLine.className = "rank-card-tier";
          tierLine.textContent = "未上分";
          text.appendChild(tierLine);

          const lpLine = document.createElement("div");
          lpLine.className = "rank-card-lp";
          lpLine.classList.add("text-muted");
          lpLine.textContent = "等待排位";
          text.appendChild(lpLine);
        }

        card.appendChild(text);
        return card;
      }

      let currentPage = 1;
      const gamesPerPage = 20;

      async function loadSummonerDetails(page = 1) {
        const loadingDiv = document.getElementById("loading");
        const errorDiv = document.getElementById("error-message");
        const errorText = document.getElementById("error-text");
        const gamesContainer = document.getElementById("games-container");
        const summaryDiv = document.getElementById("stats-summary");
        const paginationContainer = document.getElementById(
          "pagination-container"
        );

        // 显示加载状态
        loadingDiv.style.display = "block";
        errorDiv.classList.add("d-none");
        gamesContainer.innerHTML = "";
        summaryDiv.style.display = "none";
        paginationContainer.style.display = "none";

        try {
          let historyUrl = "";
          if (summonerPuuid && summonerPuuid.length > 0) {
            historyUrl = `/get_history?puuid=${encodeURIComponent(
              summonerPuuid
            )}&page=${page}`;
          } else {
            historyUrl = `/get_history?name=${encodeURIComponent(
              summonerName
            )}&page=${page}`;
          }
          const response = await fetch(historyUrl);
          const data = await response.json();

          loadingDiv.style.display = "none";

          if (!data.success || !data.games || data.games.length === 0) {
            errorDiv.classList.remove("d-none");
            errorText.textContent = data.message || "未找到战绩数据";
            return;
          }

          currentPage = page;

          // 显示统计摘要
          displayStatsSummary(data.games, summaryDiv);

          // 显示游戏列表
          displayGames(data.games, gamesContainer);

          // 异步加载外部OP.GG占位数据（最常用的前3个英雄）
          try {
            loadExternalChampionStats(data.games);
          } catch (extErr) {
            console.debug("external champion stats load failed", extErr);
          }

          // 显示分页控件
          displayPagination(data.games.length, paginationContainer);
        } catch (error) {
          console.error("加载战绩失败:", error);
          loadingDiv.style.display = "none";
          errorDiv.classList.remove("d-none");
          errorText.textContent = "网络错误，请稍后重试";
        }
        // 异步请求并渲染段位信息（如果服务器端未渲染）
        try {
          fetchAndRenderRank();
        } catch (e) {
          console.debug("fetchAndRenderRank error", e);
        }
      }

      async function fetchAndRenderRank() {
        const rankContainer = document.getElementById("rank-panel-container");
        if (!rankContainer) return;

        // Check if rank data already exists (from server-side rendering)
        const hasExistingRankData = rankContainer.querySelector(".rank-card");

        try {
          let url = "";
          if (summonerPuuid && summonerPuuid.length > 0) {
            url = `/get_summoner_rank?puuid=${encodeURIComponent(
              summonerPuuid
            )}`;
          } else if (summonerName) {
            url = `/get_summoner_rank?name=${encodeURIComponent(summonerName)}`;
          } else {
            return;
          }

          const resp = await fetch(url);
          if (!resp.ok) {
            // If we already have rank data, keep it instead of showing error
            if (hasExistingRankData) {
              console.warn(
                "Failed to refresh rank data, keeping existing data"
              );
              return;
            }
            // HTTP error - likely server issue or LCU not connected
            rankContainer.innerHTML = "";
            const warn = document.createElement("div");
            warn.className = "alert alert-warning";
            warn.innerHTML = `
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <strong>无法获取段位信息</strong><br>
              <small>请确保 League Client 已打开并已登录。如果问题持续，请刷新页面。</small>
            `;
            rankContainer.appendChild(warn);
            return;
          }

          const data = await resp.json();
          if (!data || !data.success) {
            // If we already have rank data, keep it instead of showing error
            if (hasExistingRankData) {
              console.warn(
                "Failed to refresh rank data, keeping existing data"
              );
              return;
            }
            // Backend returned a structured failure
            rankContainer.innerHTML = "";
            const warn2 = document.createElement("div");
            warn2.className = "alert alert-warning";
            const message =
              data && data.message ? data.message : "无法获取段位数据";
            warn2.innerHTML = `
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              ${message}
            `;
            rankContainer.appendChild(warn2);
            return;
          }

          const avatar = document.querySelector(".header-card .summoner-icon");
          if (avatar && data.profile_icon_id) {
            avatar.src = `https://ddragon.leagueoflegends.com/cdn/15.21.1/img/profileicon/${data.profile_icon_id}.png`;
          }

          const headerInfo = document.querySelector(".header-info");
          if (headerInfo && data.summoner_level && data.summoner_level > 0) {
            let levelBadge = headerInfo.querySelector(".summoner-level-badge");
            if (!levelBadge) {
              levelBadge = document.createElement("span");
              levelBadge.className = "summoner-level-badge";
              headerInfo.insertBefore(levelBadge, rankContainer);
            }
            levelBadge.textContent = `等级 ${data.summoner_level}`;
          }

          const ranked = data.ranked || {};
          let queues = [];
          if (Array.isArray(ranked.queues) && ranked.queues.length) {
            queues = ranked.queues.slice();
          } else {
            if (
              Array.isArray(ranked.queueSummaries) &&
              ranked.queueSummaries.length
            ) {
              queues = queues.concat(ranked.queueSummaries);
            }
            if (Array.isArray(ranked.entries) && ranked.entries.length) {
              queues = queues.concat(ranked.entries);
            }
            if (Array.isArray(ranked.raw) && ranked.raw.length) {
              queues = queues.concat(ranked.raw);
            }
          }

          const SOLO_QUEUE_TYPES = new Set([
            "RANKED_SOLO_5X5",
            "RANKED_SOLO",
            "SOLO",
          ]);
          const FLEX_QUEUE_TYPES = new Set([
            "RANKED_FLEX_SR",
            "RANKED_FLEX",
            "FLEX",
            "RANKED_FLEX_5X5",
          ]);

          const pickQueue = (typeSet) =>
            queues.find((queue) => {
              if (!queue || typeof queue !== "object") return false;
              const qType = (queue.queueType || queue.queue || queue.type || "")
                .toString()
                .toUpperCase();
              return typeSet.has(qType);
            }) || null;

          const soloSummary = summarizeRankQueue(
            pickQueue(SOLO_QUEUE_TYPES),
            "单双排 (Solo/Duo)"
          );
          const flexSummary = summarizeRankQueue(
            pickQueue(FLEX_QUEUE_TYPES),
            "灵活排位 (Flex)"
          );

          rankContainer.innerHTML = "";
          rankContainer.appendChild(createRankCard(soloSummary, "solo"));
          rankContainer.appendChild(createRankCard(flexSummary, "flex"));
        } catch (e) {
          console.error("fetchAndRenderRank failed", e);
          // If we already have rank data, keep it; otherwise show nothing
          if (!rankContainer.querySelector(".rank-card")) {
            rankContainer.innerHTML = "";
            const warn = document.createElement("div");
            warn.className = "alert alert-info";
            warn.innerHTML = `
              <i class="bi bi-info-circle-fill me-2"></i>
              <small>段位信息加载失败，请稍后重试</small>
            `;
            rankContainer.appendChild(warn);
          }
        }
      }

      function displayPagination(gamesCount, container) {
        if (gamesCount === 0) {
          container.style.display = "none";
          return;
        }

        const hasPrev = currentPage > 1;
        const hasNext = gamesCount >= gamesPerPage; // 如果当前页有20场游戏，可能还有下一页

        // 捕获当前页码值，避免闭包问题
        const prevPage = currentPage - 1;
        const nextPage = currentPage + 1;

        container.innerHTML = `
            <button class="pagination-btn" id="prev-page-btn" ${
              !hasPrev ? "disabled" : ""
            }>
                <i class="bi bi-chevron-left"></i> 上一页
            </button>
            <span class="page-info">第 ${currentPage} 页</span>
            <button class="pagination-btn" id="next-page-btn" ${
              !hasNext ? "disabled" : ""
            }>
                下一页 <i class="bi bi-chevron-right"></i>
            </button>
        `;
        container.style.display = "flex";

        // 添加事件监听器 - 使用捕获的页码值
        if (hasPrev) {
          document
            .getElementById("prev-page-btn")
            .addEventListener("click", () => loadPage(prevPage));
        }
        if (hasNext) {
          document
            .getElementById("next-page-btn")
            .addEventListener("click", () => loadPage(nextPage));
        }
      }

      function loadPage(page) {
        window.scrollTo({ top: 0, behavior: "smooth" });
        loadSummonerDetails(page);
      }

      function displayStatsSummary(games, container) {
        const totalGames = games.length;
        const wins = games.filter((g) => g.win).length;
        const losses = totalGames - wins;
        const winRate = ((wins / totalGames) * 100).toFixed(1);

        let totalKills = 0,
          totalDeaths = 0,
          totalAssists = 0;
        games.forEach((game) => {
          const [k, d, a] = game.kda.split("/").map(Number);
          totalKills += k;
          totalDeaths += d;
          totalAssists += a;
        });

        const avgKills = (totalKills / totalGames).toFixed(1);
        const avgDeaths = (totalDeaths / totalGames).toFixed(1);
        const avgAssists = (totalAssists / totalGames).toFixed(1);
        const kdaRatio =
          totalDeaths > 0
            ? ((totalKills + totalAssists) / totalDeaths).toFixed(2)
            : "Perfect";

        container.innerHTML = `
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="summary-card text-center">
                    <div class="card-body">
                        <i class="bi bi-controller fs-2 text-primary mb-2"></i>
                        <h6 class="text-muted">总场次</h6>
                        <h3 class="mb-0 fw-bold">${totalGames}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="summary-card text-center">
                    <div class="card-body">
                        <i class="bi bi-trophy fs-2 ${
                          winRate >= 50 ? "text-success" : "text-danger"
                        } mb-2"></i>
                        <h6 class="text-muted">胜率</h6>
                        <h3 class="mb-0 fw-bold ${
                          winRate >= 50 ? "text-success" : "text-danger"
                        }">${winRate}%</h3>
                        <small class="text-muted">${wins}胜 ${losses}败</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="summary-card text-center">
                    <div class="card-body">
                        <i class="bi bi-graph-up fs-2 text-info mb-2"></i>
                        <h6 class="text-muted">平均KDA</h6>
                        <h3 class="mb-0 fw-bold text-info">${avgKills}/${avgDeaths}/${avgAssists}</h3>
                        <small class="text-muted">比值: ${kdaRatio}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="summary-card text-center">
                    <div class="card-body">
                        <i class="bi bi-star fs-2 text-warning mb-2"></i>
                        <h6 class="text-muted">总击杀</h6>
                        <h3 class="mb-0 fw-bold text-warning">${totalKills}</h3>
                        <small class="text-muted">总助攻: ${totalAssists}</small>
                    </div>
                </div>
            </div>
        `;
        container.style.display = "flex";
      }

      function getMostPlayedChampion(games) {
        const champCount = {};
        games.forEach((game) => {
          champCount[game.champion_en] =
            (champCount[game.champion_en] || 0) + 1;
        });
        const mostPlayed = Object.entries(champCount).sort(
          (a, b) => b[1] - a[1]
        )[0];
        return mostPlayed ? `${mostPlayed[0]} (${mostPlayed[1]}场)` : "N/A";
      }

      // 游戏模式名称映射
      function getModeName(mode) {
        const modeMap = {
          CLASSIC: "经典模式",
          ARAM: "极地大乱斗",
          KIWI: "海克斯大乱斗",
          CHERRY: "斗魂竞技场",
          URF: "无限火力",
          ONEFORALL: "克隆模式",
          NEXUSBLITZ: "激斗峡谷",
          TUTORIAL: "教程",
          PRACTICETOOL: "训练模式",
        };
        return modeMap[mode] || mode;
      }

      function renderModeBadge(modeCode) {
        if (!modeCode) return "";
        const meta = MODE_ICON_MAP[modeCode] || MODE_ICON_MAP._default;
        const label = getModeName(modeCode);
        const badgeStyles = [];
        if (meta.badgeBg) badgeStyles.push(`background: ${meta.badgeBg}`);
        if (meta.textColor) badgeStyles.push(`color: ${meta.textColor}`);
        const badgeAttr = badgeStyles.length
          ? ` style="${badgeStyles.join("; ")}"`
          : "";
        const iconStyles = [];
        if (meta.iconBg) iconStyles.push(`background: ${meta.iconBg}`);
        if (meta.iconColor) iconStyles.push(`color: ${meta.iconColor}`);
        const iconAttr = iconStyles.length
          ? ` style="${iconStyles.join("; ")}"`
          : "";
        return `<span class="mode-badge"${badgeAttr}><span class="mode-icon"${iconAttr}><i class="${meta.icon}"></i></span><span class="mode-label">${label}</span></span>`;
      }

      function renderResultBadge(won) {
        const cls = won ? "win" : "loss";
        const icon = won ? "bi-trophy-fill" : "bi-x-circle-fill";
        const label = won ? "胜利" : "失败";
        return `<span class="result-badge ${cls}"><i class="bi ${icon}"></i>${label}</span>`;
      }

      function getArenaPlacement(game) {
        if (!game || typeof game !== "object") return null;
        const candidates = [
          game.placement,
          game.arenaPlacement,
          game.arena_placement,
          game.subteamPlacement,
          game.arenaRank,
          game.rank,
          game.placementRank,
          game.playerPlacement,
        ];
        for (const value of candidates) {
          if (value === undefined || value === null) continue;
          const num = Number(value);
          if (!Number.isNaN(num) && num > 0) {
            return num;
          }
        }
        return null;
      }

      function renderArenaBadge(placement) {
        if (!Number.isFinite(placement)) return "";
        const rankEmojis = ["🥇", "🥈", "🥉", "4️⃣", "5️⃣", "6️⃣", "7️⃣", "8️⃣"];
        const emoji = rankEmojis[placement - 1] || `#${placement}`;
        const topHalf = placement <= 4;
        const cls = topHalf ? "top" : "bottom";
        const icon = topHalf ? "bi-trophy-fill" : "bi-flag-fill";
        return `<span class="arena-badge ${cls}"><i class="bi ${icon}"></i>${emoji} 第 ${placement} 名</span>`;
      }

      function renderKdaBadge(kills, deaths, assists) {
        const total = (kills || 0) + (assists || 0);
        const ratio = deaths > 0 ? total / deaths : total;
        let cls = "kda-bad";
        if (deaths === 0 && total > 0) {
          cls = "kda-perfect";
        } else if (ratio >= 5) {
          cls = "kda-excellent";
        } else if (ratio >= 3) {
          cls = "kda-good";
        }
        const ratioText =
          deaths === 0 && total > 0 ? "Perfect KDA" : `${ratio.toFixed(2)} KDA`;
        return `
        <div class="kda-badge ${cls}">
          <span class="kda-icon"><i class="bi bi-sword"></i></span>
          <div class="kda-text">
            <div class="kda-main">${kills}/${deaths}/${assists}</div>
            <div class="kda-sub">${ratioText}</div>
          </div>
        </div>
      `;
      }

      function displayGames(games, container) {
        // keep games globally so toggleMatchDetails can access them
        window._games = games;

        container.innerHTML = games
          .map((game, index) => {
            const isCherryMode =
              game.mode === "CHERRY" ||
              game.gameMode === "CHERRY" ||
              game.mode === "斗魂竞技场";

            // 计算全局游戏编号：当前页 * 每页数量 + 索引 + 1
            const globalIndex = (currentPage - 1) * gamesPerPage + index + 1;

            const modeName = getModeName(game.gameMode || game.mode);

            // 直接使用game对象的win字段（后端已处理好）
            const won =
              game.win === true ||
              game.win === "true" ||
              String(game.win).toLowerCase() === "win";
            const winClass = won ? "win-bg" : "loss-bg";
            const winText = won ? "胜利" : "失败";
            const winIcon = won
              ? "trophy-fill text-success"
              : "x-circle-fill text-danger";
            const resultBadgeHtml = renderResultBadge(won);
            const arenaBadgeHtml =
              game.mode === "CHERRY" ||
              game.gameMode === "CHERRY" ||
              game.mode === "斗魂竞技场"
                ? renderArenaBadge(getArenaPlacement(game))
                : "";

            // 解析KDA
            let kills = 0,
              deaths = 0,
              assists = 0;
            if (
              game.kda &&
              typeof game.kda === "string" &&
              game.kda.indexOf("/") > -1
            ) {
              [kills, deaths, assists] = game.kda
                .split("/")
                .map((x) => parseInt(x) || 0);
            }
            const kda =
              deaths > 0
                ? (((kills || 0) + (assists || 0)) / (deaths || 1)).toFixed(2)
                : "Perfect";

            // 英雄等级：后端简化数据没有champion_level，需要通过详细数据获取，暂时显示为空或从KDA推测
            // 由于后端返回的简化列表没有等级信息，我们先不显示或显示"--"
            const championLevel =
              game.champion_level || game.championLevel || game.level || "";

            // 金币：后端已经是k单位（12表示12k），直接显示
            const goldVal = game.gold || 0;
            // 后端返回的gold已经是k为单位（例如12 = 12k），直接添加k后缀
            let goldFormatted;
            if (goldVal > 0 && goldVal < 1000) {
              // 小于1000说明是k单位，直接加k
              goldFormatted = goldVal + "k";
            } else if (goldVal >= 1000) {
              // 大于等于1000说明是原始金币值，需要格式化
              goldFormatted = fmt(goldVal);
            } else {
              goldFormatted = "0";
            }

            return `
                <div class="card game-card ${winClass}" style="position: relative;">
                    <div class="card-body p-4">
                        <div class="row align-items-center g-3">
                            <!-- 左侧：英雄信息 -->
                            <div class="col-md-2 col-champion">
                                <div class="champion-wrapper">
                                    <img src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/champion/${
                                      game.champion_en || ""
                                    }.png" 
                                         alt="${game.champion_en || ""}" 
                                         class="champion-icon">
                                    ${
                                      championLevel
                                        ? `<div class="level-badge">${championLevel}</div>`
                                        : ""
                                    }
                                </div>
                                <h6 class="mt-2 mb-0 text-center fw-bold">${
                                  game.champion_en || ""
                                }</h6>
                            </div>

                            <!-- 中间：战绩数据 -->
                            <div class="col-md-6 col-info">
                                <div class="d-flex align-items-center flex-wrap gap-3 mb-3">
                                    ${resultBadgeHtml}
                                    ${renderModeBadge(
                                      game.gameMode || game.mode
                                    )}
                                    ${arenaBadgeHtml}
                                </div>

                                <div class="mb-3">
                                    ${renderKdaBadge(kills, deaths, assists)}
                                </div>
                                
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="badge stats-badge badge-gold">
                                        <i class="bi bi-coin me-1"></i>
                                        ${goldFormatted} 金币
                                    </span>
                                    ${
                                      game.cs
                                        ? `<span class="badge stats-badge badge-cs">
                                        <i class="bi bi-bullseye me-1"></i>
                                        ${game.cs} CS
                                    </span>`
                                        : ""
                                    }
                                </div>
                            </div>

                            <!-- 右侧：时间和操作 -->
                            <div class="col-md-4 col-meta">
                                <div class="text-end">
                                    <div class="mb-2">
                                        <i class="bi bi-clock me-1 text-muted"></i>
                                        <span class="text-muted">${
                                          game.time_ago || ""
                                        }</span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="badge bg-light text-dark px-3 py-1">第 ${globalIndex} 场</span>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary rounded-pill me-2" onclick="toggleMatchDetails(${index})" type="button">
                                            <i class="bi bi-chevron-down me-1"></i>详情
                                        </button>
                                        <a class="btn btn-sm btn-outline-secondary rounded-pill" 
                                            href="/match/${encodeURIComponent(
                                              summonerName
                                            )}/${index}?match_id=${encodeURIComponent(
              game.match_id || ""
            )}"
                                            target="_blank" rel="noopener noreferrer">
                                            <i class="bi bi-box-arrow-up-right"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- inline details container (collapsed by default) -->
                        <div id="match-details-${index}" class="match-details mt-3" style="display:none;"></div>
                    </div>
                </div>
            `;
          })
          .join("");
      }

      // External champion stats placeholder integration
      function loadExternalChampionStats(games) {
        if (!Array.isArray(games) || games.length === 0) return;
        // Count usage by champion_en
        const counts = {};
        for (const g of games) {
          const key = (g.champion_en || "").trim();
          if (!key) continue;
          counts[key] = (counts[key] || 0) + 1;
        }
        const sorted = Object.entries(counts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3)
          .map(([k]) => k);
        if (sorted.length === 0) return;

        const host = window.location.origin;
        const container = document.getElementById("external-champion-stats");
        if (!container) return;
        container.innerHTML =
          '<div class="text-muted small">加载 OP.GG 英雄数据...</div>';

        Promise.all(
          sorted.map((champ) =>
            fetch(
              `/external/champion_stats?champion=${encodeURIComponent(champ)}`
            )
              .then((r) => r.json())
              .catch(() => ({ success: false, champion: champ }))
          )
        ).then((results) => {
          const rows = results.map((res) => {
            if (!res || !res.success || !res.data) {
              return `<div class="ext-champ-row text-muted">${
                res.champion || "未知"
              }: 外部数据不可用</div>`;
            }
            const d = res.data;
            const displayName = d.name || d.champion || "";
            const tags = Array.isArray(d.tags) ? d.tags.join("/") : "";
            const title = d.title ? ` ${d.title}` : "";
            const metaInfo = tags
              ? ` <span class="text-muted small">(${tags})</span>`
              : "";
            return `<div class="ext-champ-row">
              <span class="ext-champ-name">${displayName}</span>${metaInfo}
              <span class="ext-champ-badge" title="胜率">胜率: ${
                d.win_rate
              }%</span>
              <span class="ext-champ-badge" title="选取率">选取: ${
                d.pick_rate
              }%</span>
              <span class="ext-champ-badge" title="禁用率">禁用: ${
                d.ban_rate
              }%</span>
              <span class="ext-champ-badge" title="强度分层">Tier: ${
                d.tier
              }</span>
              ${
                d.cached
                  ? '<span class="ext-champ-cache" title="缓存">缓存</span>'
                  : ""
              }
            </div>`;
          });
          container.innerHTML = `<div class="ext-champ-wrapper">${rows.join(
            ""
          )}</div>`;
        });
      }

      async function toggleMatchDetails(index) {
        const detailsId = `match-details-${index}`;
        const el = document.getElementById(detailsId);
        if (!el) return;

        // 如果已经加载过，直接切换显示
        if (el.dataset.loaded === "true") {
          el.style.display = el.style.display === "none" ? "block" : "none";
          return;
        }

        // 显示加载动画
        el.style.display = "block";
        el.innerHTML = `<div class="text-center py-3"><div class="spinner-border" role="status"><span class="visually-hidden">加载中...</span></div></div>`;

        try {
          const games = window._games || [];
          const gameMeta = games[index];
          let resp;
          if (gameMeta && gameMeta.match_id) {
            resp = await fetch(
              `/get_match?match_id=${encodeURIComponent(gameMeta.match_id)}`
            );
          } else {
            resp = await fetch(
              `/get_match?name=${encodeURIComponent(
                summonerName
              )}&index=${index}`
            );
          }
          const data = await resp.json();
          console.debug("get_match response for index", index, data);
          if (!data.success) {
            el.innerHTML = `<div class="alert alert-warning">无法获取对局详情: ${
              data.message || "未知错误"
            }</div>`;
            el.dataset.loaded = "true";
            return;
          }

          const game = data.game;
          try {
            el.innerHTML = renderInlineMatchDetail(game);
          } catch (renderErr) {
            console.error("renderInlineMatchDetail failed", renderErr, game);
            el.innerHTML = `<div class="alert alert-danger">渲染对局详情失败（控制台查看错误）</div>`;
          }
          el.dataset.loaded = "true";
        } catch (e) {
          console.error(e);
          el.innerHTML = `<div class="alert alert-danger">加载对局详情失败</div>`;
          el.dataset.loaded = "true";
        }
      }

      // 通用玩家信息渲染函数（CHERRY 和普通模式共用）
      function renderPlayerHtml(p, idx) {
        const name =
          p.summonerName ||
          (p.player &&
            (p.player.gameName
              ? p.player.gameName +
                (p.player.tagLine ? "#" + p.player.tagLine : "")
              : p.player.summonerName)) ||
          "未知";
        const playerPuuid = p.puuid || (p.player && p.player.puuid) || "";
        const icon =
          p.profileIcon ||
          (p.player && p.player.profileIcon) ||
          p.profileIconId ||
          "";
        // resolve champion image key via CHAMPION_MAP (server-provided)
        const champKey =
          p.championId && CHAMPION_MAP && CHAMPION_MAP[p.championId]
            ? CHAMPION_MAP[p.championId]
            : p.champion || p.championName || "";
        const champImg = champKey
          ? `<img src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/champion/${champKey}.png" class="champion-icon me-2" onerror="this.style.display='none'">`
          : "";
        const level = (p.stats && p.stats.champLevel) || p.champLevel || 0;
        const champWrapper = champImg
          ? `<div class="champion-wrapper">${champImg}${
              level ? `<span class="level-badge">${level}</span>` : ""
            }</div>`
          : "";
        const k = p.stats ? p.stats.kills : p.kills || 0;
        const d = p.stats ? p.stats.deaths : p.deaths || 0;
        const a = p.stats ? p.stats.assists : p.assists || 0;
        const gold = (p.stats && p.stats.goldEarned) || p.gold || 0;
        const cs =
          (p.stats &&
            (p.stats.totalMinionsKilled || 0) +
              (p.stats.neutralMinionsKilled || 0)) ||
          p.cs ||
          0;
        const damage =
          (p.stats && (p.stats.totalDamageDealtToChampions || 0)) ||
          p.totalDamageDealtToChampions ||
          0;
        const heal = (p.stats && p.stats.totalHeal) || p.totalHeal || 0;
        const vision = (p.stats && p.stats.visionScore) || p.visionScore || 0;
        const items = [];
        if (p.stats) {
          for (let i = 0; i < 7; i++) {
            const key = "item" + i;
            if (p.stats[key] !== undefined) items.push(p.stats[key]);
          }
        }
        const itemsHtml = items
          .map((id) =>
            id
              ? `<img src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/item/${id}.png" class="item-icon" onerror="this.style.display='none'">`
              : ""
          )
          .join("");

        // 提取增强（Augments）- KIWI/CHERRY模式
        let augmentsHtml = "";
        if (p.stats && p.stats.playerAugment1) {
          const augments = [];
          for (let i = 1; i <= 6; i++) {
            const augId = p.stats["playerAugment" + i];
            const augIconUrl = p.stats["augmentIcon" + i];
            const augName = p.stats["augmentName" + i];
            const augDesc = p.stats["augmentDesc" + i];
            if (augId && augId > 0) {
              augments.push({
                id: augId,
                iconUrl: augIconUrl,
                name: augName,
                desc: augDesc,
              });
            }
          }
          if (augments.length > 0) {
            augmentsHtml = `<div class="augments-row small mt-1">
                    ${augments
                      .map((aug) => {
                        // 构建tooltip内容（中文名称+描述）
                        let tooltip = aug.name || `海克斯天赋 ${aug.id}`;
                        if (aug.desc) {
                          // 清理HTML标签并截断描述
                          const cleanDesc = aug.desc
                            .replace(/<[^>]+>/g, "")
                            .substring(0, 200);
                          tooltip = `${aug.name}\\n${cleanDesc}${
                            cleanDesc.length >= 200 ? "..." : ""
                          }`;
                        }

                        if (aug.iconUrl) {
                          return `<img src="${aug.iconUrl}" 
                                class="augment-icon" 
                                title="${tooltip.replace(/"/g, "&quot;")}" 
                                onerror="this.onerror=null;this.outerHTML='<span class=\\'badge\\' style=\\'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.75rem; padding: 2px 6px;\\' title=\\'${tooltip.replace(
                                  /"/g,
                                  "&quot;"
                                )}\\'>⚡${aug.id}</span>';">`;
                        } else {
                          // 如果没有图标URL，显示文本徽章
                          return `<span class='badge' style='background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.75rem; padding: 2px 6px;' title='${tooltip.replace(
                            /"/g,
                            "&quot;"
                          )}'>⚡${aug.id}</span>`;
                        }
                      })
                      .join(" ")}
                </div>`;
          }
        }

        const profileImg = icon
          ? `<img src="https://ddragon.leagueoflegends.com/cdn/15.21.1/img/profileicon/${icon}.png" class="profile-img" onerror="this.onerror=null;this.src='https://ddragon.leagueoflegends.com/cdn/15.21.1/img/profileicon/29.png';">`
          : `<div class="profile-placeholder"></div>`;
        // clickable area uses inline style to look like plain text (no blue/underline)
        const playerLink = `/summoner/${encodeURIComponent(
          name
        )}?puuid=${encodeURIComponent(playerPuuid)}`;
        const ratio = d > 0 ? (k + a) / d : k + a;
        const ratioNum = Math.round(ratio * 100) / 100;
        const ratioStr = ratioNum.toFixed(2);
        let kdaClass = "kda-bad";
        if (ratioNum >= 5) kdaClass = "kda-good";
        else if (ratioNum >= 3) kdaClass = "kda-mid";

        return `
            <div class="match-row ${p.win ? "win-row" : ""}">
                <div class="col-player-info">
                    <a href="${playerLink}" class="player-link" target="_blank">${profileImg}</a>
                    <div>
                        <div class="player-name"><a href="${playerLink}" class="player-link player-name" target="_blank">${name}</a></div>
                        <div class="small-muted">${p.role || ""} ${
          p.lane || ""
        }</div>
                        ${augmentsHtml}
                    </div>
                </div>
                <div class="col-champion">${champWrapper}</div>
                <div class="col-kda">
                    <span class="kda-prominent ${kdaClass}">${k}/${d}/${a}</span>
                    <div class="small-muted" style="color: #495057; font-weight: 600;">${ratioStr} KDA</div>
                </div>
                <div class="col-items-wrapper">
                    <div class="items-row">${itemsHtml}</div>
                    <div class="stats-row small-muted">${fmt(
                      gold
                    )}g · ${cs} CS · ${fmt(damage)} DMG</div>
                </div>
            </div>`;
      }

      // CHERRY 模式渲染函数
      function renderCherryMode(game, sortedSubteams) {
        // 前4名为获胜队伍
        const winningSubteams = sortedSubteams.filter((t) => t.placement <= 4);
        const losingSubteams = sortedSubteams.filter((t) => t.placement > 4);

        function subteamHtml(subteam) {
          const placement = subteam.placement;
          const isWinning = placement <= 4;
          const rankEmoji =
            ["🥇", "🥈", "🥉", "4️⃣", "5️⃣", "6️⃣", "7️⃣", "8️⃣"][placement - 1] ||
            `#${placement}`;

          return `
                <div class="mb-3 p-2 rounded ${
                  isWinning ? "bg-light-success" : "bg-light"
                }" style="border-left: 4px solid ${
            isWinning ? "#28a745" : "#6c757d"
          }">
                    <h6 class="mb-2">
                        <span class="badge ${
                          isWinning ? "bg-success" : "bg-secondary"
                        }">${rankEmoji} 排名 ${placement}</span>
                        <span class="badge bg-info ms-2">子队 ${
                          subteam.subteamId
                        }</span>
                    </h6>
                    ${subteam.players
                      .map((p, i) => renderPlayerHtml(p, i))
                      .join("")}
                </div>
            `;
        }

        let headerTimeHtml = "";
        try {
          const startDate = normalizeToDate(game.gameCreation);
          if (startDate) {
            const durationSec = Number(game.gameDuration) || 0;
            const endDate = new Date(startDate.getTime() + durationSec * 1000);
            const minutes = Math.floor(durationSec / 60);
            const seconds = durationSec % 60;
            const startStr = formatGameTime(startDate);
            const endStr = formatGameTime(endDate);
            headerTimeHtml = `<div class="mb-2 text-muted">
                    <span class="badge bg-primary me-2">斗魂竞技场 (2v2v2v2)</span>
                    时长: ${minutes} 分 ${seconds} 秒 • 开始: ${startStr} • 结束: ${endStr}
                </div>`;
          }
        } catch (e) {
          headerTimeHtml = "";
        }

        return `
            <div class="card mt-2">
                <div class="card-body">
                    ${headerTimeHtml}
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-success mb-3">
                                <i class="bi bi-trophy-fill me-2"></i>获胜队伍 (前4名)
                            </h5>
                            ${winningSubteams
                              .map((st) => subteamHtml(st))
                              .join("")}
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-secondary mb-3">
                                <i class="bi bi-x-circle-fill me-2"></i>失败队伍 (后4名)
                            </h5>
                            ${losingSubteams
                              .map((st) => subteamHtml(st))
                              .join("")}
                        </div>
                    </div>
                </div>
            </div>
        `;
      }

      function renderInlineMatchDetail(game) {
        if (!game) return `<div class="text-muted">无对局数据</div>`;
        const participants = game.participants || [];
        const gameMode = game.gameMode || "";

        // CHERRY 模式：按子队伍分组
        const isCherryMode = gameMode === "CHERRY";

        if (isCherryMode) {
          // 按子队伍分组
          const subteams = {};
          participants.forEach((p) => {
            const subteamId = (p.stats && p.stats.playerSubteamId) || 0;
            if (!subteams[subteamId]) {
              subteams[subteamId] = {
                players: [],
                placement: (p.stats && p.stats.subteamPlacement) || 0,
              };
            }
            subteams[subteamId].players.push(p);
          });

          // 转换为数组并按排名排序
          const sortedSubteams = Object.entries(subteams)
            .map(([id, data]) => ({ subteamId: id, ...data }))
            .sort((a, b) => a.placement - b.placement);

          return renderCherryMode(game, sortedSubteams);
        }

        // 普通模式：按队伍分组
        const teamA = participants.filter((p) => p.teamId === 100);
        const teamB = participants.filter((p) => p.teamId === 200);
        // determine winning teamId from game.teams if present
        const winningTeamId = (game.teams || []).reduce((winId, t) => {
          // some payloads use 'win': 'Win' or boolean true
          if (t.win === true || String(t.win).toLowerCase() === "win")
            return t.teamId || winId;
          return winId;
        }, null);

        // show start/end times and duration above teams
        let headerTimeHtml = "";
        try {
          const startDate = normalizeToDate(game.gameCreation);
          if (startDate) {
            const durationSec = Number(game.gameDuration) || 0;
            const endDate = new Date(startDate.getTime() + durationSec * 1000);
            const minutes = Math.floor(durationSec / 60);
            const seconds = durationSec % 60;
            const startStr = formatGameTime(startDate);
            const endStr = formatGameTime(endDate);
            headerTimeHtml = `<div class="mb-2 text-muted">时长: ${minutes} 分 ${seconds} 秒 • 开始: ${startStr} • 结束: ${endStr}</div>`;
          }
        } catch (e) {
          headerTimeHtml = "";
        }
        return `
            <div class="card mt-2">
                <div class="card-body">
                    ${headerTimeHtml}
                    <div class="row">
                        <div class="col-md-6">
                            <h6>队伍 1 ${
                              winningTeamId === 100
                                ? '<span class="badge bg-success ms-2">胜利</span>'
                                : ""
                            }</h6>
                            ${teamA
                              .map((p, i) => renderPlayerHtml(p, i))
                              .join("")}
                        </div>
                        <div class="col-md-6">
                            <h6>队伍 2 ${
                              winningTeamId === 200
                                ? '<span class="badge bg-success ms-2">胜利</span>'
                                : ""
                            }</h6>
                            ${teamB
                              .map((p, i) => renderPlayerHtml(p, i))
                              .join("")}
                        </div>
                    </div>
                </div>
            </div>
        `;
      }

      // 页面加载时执行
      document.addEventListener("DOMContentLoaded", () =>
        loadSummonerDetails()
      );
    </script>
  </body>
</html>
